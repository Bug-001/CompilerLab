# 编译原理Lab3实验报告

| 实验内容 |        词法分析和语法分析         |
| :------: | :-------------------------------: |
|   组号   |                 5                 |
|   组长   | 苏海涛 191850169@smail.nju.edu.cn |
|   组员   | 任天骐 191180103@smail.nju.edu.cn |

## 1. 编译运行程序

输入`make`即可。会在Makefile路径下产生可执行文件`parser`。

`parser`接受一个或两个参数，即：

```
./parser in.cmm [out.ir]
```

当`out.ir`留空时，`parser`将产生的中间代码打印到`stdout`上。

## 2. 程序功能

- 完成了必做和选做3.2的全部要求。所有用户显式定义的变量以`var`开头，所有临时变量以`temp`开头，所有地址变量以`addr`开头；
- `parser`提供了对高维数组参数的支持（选做3.2未要求该内容，然而数组不管多少维都只是个地址罢了，可以以相同的方式处理）；
- 在保证输出正确的前提下，采用多种方式对IR优化，使程序执行步数减少约60%。

## 3. 正确生成IR

本实验尽可能地将语义分析和IR生成的代码剥离，这样虽略微降低编译器效率，但模块性好，程序的正确性容易得到保障。

IR生成的入口函数为`ir.c:function_translator`。当某个函数的语义分析和类型检查结束之后，如果无误，就调用该IR生成函数。在生成IR时，程序按着和语义分析完全相同的顺序，向下遍历语法树节点。语义分析中得到的类型和符号编号等信息已经保存在了语法树节点中，可供IR生成的部分直接使用。

普通的表达式、流程控制等中间代码的生成都非常简单，讲义已经描述清楚。每一个`Exp`子表达式的值都会存放在一个临时变量中，这使中间代码行为的正确性相当容易验证。

而不管是数组元素、高维数组的元素的元素，还是结构体的成员，要想对它们进行读写，都要先算出其地址，才可进行LOAD或STORE等操作。通过设定`place`参数的类型，我们可以告诉被调用的函数（例如`translate_Exp`）求出地址还是求出地址指向的变量的值。

归纳一下，会发现情况并不多。首先，如果是一般的算术表达式（加减乘除等），当然是要求值。如果是赋值语句`x = y`，列举每一种情况：

- `x`是基本类型，那么`y`当然是求表达式的值，`x`更是。如果`y`不是一个基本类型，说明语义分析写错了。
- `x`是复合类型，`y`是基本类型。这对应于数组元素或结构体域的LOAD操作，因此要求出`x`的地址。
- `x`和`y`都是复合类型，由于C--没有指针类型，所以这就是数组的拷贝，故求出二者的地址，然后生成数组拷贝的IR。

如果是函数参数传递，一旦发现参数是数组，便直接传地址。在被调用函数中，函数参数和局部变量混杂在一起，但前者是地址，后者不是，需设法将其区分开来。解决办法是在语义分析时，对函数参数变量设置特殊位，生成中间代码时检测到这一特殊位的话，就产生`addr := var`，否则产生`addr := &var`。

## 4. 谨慎优化

由于每个子表达式都产生了一个临时变量，IR虽然正确，但臃肿不堪。好在通过一些简单的技巧就可以大幅提升IR的效率。

优化的可能情况是很多的，为了写出风格良好、语义清晰的代码，有必要做事先的设计。首先，生成IR时，操作数本身必须保存引用和赋值的信息。如果一个临时变量只被赋值1次且只被引用1次，那么这样的临时变量明显是有优化余地的。IR生成结束后，遍历每一条IR：

- 如果是赋值语句，它可以进行相当程度的展开，不仅可以通过赋值链直通最初的变量或常量，并消除中间的所有临时变量；还能变成算术运算、地址访问等其它类型的语句，因为赋值语句只使用了两个操作数。如果条件允许，甚至还能变成一条`READ`语句。
- 如果是算术运算、地址访问或传参、返回等语句，它的每一个操作数都可以沿着赋值链，在原位展开。对于算术运算，它还可以进行常量折叠优化，大幅减少数组元素地址、常量表达式等的计算开销。
- 如果是条件跳转，可以进行窥孔优化，消除一些冗余的`GOTO`和`LABEL`。

在进行以上的分析之后，引用信息会发生改变，有些变量和标签会不再有引用，因而可以将其删去。同时，还可以利用窥孔优化消除冗余的`GOTO`语句。重复以上所有步骤直至IR不再变化，即产生最终的IR。虚拟机上的实验表明，程序在保证行为正确的情况下，指令条数较原来减少了约60%。
